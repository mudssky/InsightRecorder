# 设备连接与导出（M1）任务拆分与顺序执行步骤

## 总览目标

- 自动识别录音笔为可移动磁盘；展示容量信息；一键批量导出“新文件”并重命名到指定目录；可选导出后清空设备。

## 前置准备

- 依赖与工具：`drivelist`（设备枚举）、`chokidar`（目录监听）、`fast-glob`（扫描）、`Prisma` + SQLite。
- 数据库位置：`app.getPath('userData')/insight-recorder.db`，主进程独占连接；渲染端仅经 IPC 访问。
- 安全基线：Electron `contextIsolation: true`、`sandbox: true`；渲染端不直接持有数据库句柄；IPC 参数与返回使用 `zod` 校验。

## 任务拆分

- 设备检测与容量采集（可移动磁盘插拔事件、盘符/挂载点、容量信息）
- SQLite 初始化与 Prisma 模型与迁移（`AppSettings`/`Device`/`ExportHistory`/`ExportIndex`）
- Preload IPC 白名单与类型定义（`settings.*`、`device.list`、`export.*`）及 schema 校验
- 渲染端设备列表与容量展示（含最近扫描缓存与触发扫描）
- 批量导出管线（过滤新文件、命名模板、并发与重试、目标路径白名单）
- 导出历史记录与导出索引写入（事务化、失败原因记录）
- 导出后清空策略（二次确认、回收站策略兼容、仅在成功导出后执行）
- 设置页与持久化（导出目录、重命名模板、扩展名、并发/重试、清空选项）
- 导出摘要与近期记录查询（`export.summary(limit)`）
- 备份与迁移（数据库备份到用户指定目录；Prisma Migrations 管理结构升级）

## 顺序执行步骤

1. 建模与迁移
   - 定义 Prisma schema（`AppSettings`/`Device`/`ExportHistory`/`ExportIndex`，含唯一约束与索引）。
   - 初始化数据库文件位置与连接；生成并应用初始迁移。
   - 验收：能启动并读/写默认设置；迁移成功创建全部表。

2. IPC 契约与 Preload
   - 在 `preload` 暴露经 `contextBridge` 的 API：`settings.get`、`settings.update(partial)`、`device.list`、`export.start(payload)`、`export.summary(limit)`。
   - 为每个 IPC 输入与输出定义 `zod` schema 并校验；保证类型与渲染端一致。
   - 验收：渲染端可调用 `settings.get` 返回默认配置；无安全警告。

3. 设备检测（主进程）
   - 集成 `drivelist` 枚举可移动磁盘；订阅插拔事件（轮询或系统事件结合）。
   - 采集 `label`、`mountpoint`、`capacityTotal`、`capacityFree`、`vendorId`/`productId`/`serial`；写入 `Device` 并更新 `lastSeenAt`。
   - 验收：插入设备后能在 UI 中看到设备与容量；移除后状态更新。

4. 渲染端设备列表与容量
   - 构建设备列表组件，首次请求为空时触发扫描；显示容量与卷标。
   - 支持选择目标设备与导出按钮；错误与空态提示。
   - 进度与取消：展示导出进度（任务总数、当前文件、成功/失败计数），提供“取消导出”。
   - 验收：列表刷新与容量显示准确；无未捕获异常。

5. 批量导出实现
   - 扫描设备挂载点下音频文件（扩展名来自设置）；用 `ExportIndex` 判定“新文件”。
   - 应用重命名模板：`{date:YYYYMMDD}-{time:HHmmss}-{title}-{device}`；支持主题/前缀。
   - 并发复制与失败重试（`concurrency`、`retryCount`）；目标路径白名单与存在性校验。
   - 写入 `ExportHistory` 开始/结束时间与状态；成功后写 `ExportIndex` 指纹（`deviceId+srcPath+size+mtimeMs`）。
   - 验收：一键导出完成，重命名规则正确；失败项可重试。

6. 清空设备（可选）
   - 在导出成功后，提供二次确认对话；遵循回收站策略或安全删除方案。
   - 仅当全部目标文件导出成功时允许清空；失败则跳过并提示。
   - 验收：开启选项时设备文件被清空；关闭时不执行。

7. 设置页与持久化
   - 构建设置 UI：`exportTargetPath`、`renameTemplate`、`extensions`、`concurrency`、`retryCount`、`clearAfterExport`。
   - 通过 `settings.update(partial)` 持久化并更新 `updatedAt`；渲染端表单做输入校验。
   - 验收：设置保存后立即生效；错误输入被拦截。

8. 导出摘要与历史
   - 提供 `export.summary(limit)` 返回最近 N 次任务摘要；渲染端展示列表与状态统计。
   - 验收：摘要数据正确、可分页或限制条数。

9. 备份与迁移
   - 增加数据库备份到用户指定目录的功能；记录备份时间与路径。
   - 使用 Prisma Migrations 管理后续结构升级与数据迁移。
   - 验收：备份文件可用；迁移执行成功并保持数据一致性。

10. 冒烟与验收

- 冒烟：启动应用，插入设备，执行导出与（可选）清空，全流程无异常。
- 验收标准：设备自动识别并展示；一键导出成功；重命名符合规则；容量准确显示。

## 注意事项

- 事务边界：单次导出任务在 `ExportHistory` 记录开始与结束；失败保留 `error` 并允许重试；成功后写入 `ExportIndex`。
- 路径安全：仅允许在受信白名单目录导出；对路径穿越与非法字符进行校验与规避。
- 并发控制：限制并发复制数，避免阻塞 UI 与系统。
- 可观察性：为主流程关键节点增加日志与错误提示，便于定位问题。
- 设置优先级：设备级设置优先于全局设置；未配置字段回退到 `AppSettings`。

## 设备识别页面（新增）

- 路由：`/devices`（或主界面分栏），作为设备管理与导出入口。
- 展示：设备卡片包含 `label`、`mountpoint`、容量进度（`capacityFree/capacityTotal`）、`lastSeenAt`。
- 交互：
  - `刷新`：触发 `device.list`（为空时强制扫描），更新列表与容量。
  - `弹出设备`：可选（视平台能力），安全移除提醒。
  - `配置`：打开设备级设置（见下节），覆盖全局导出行为。
  - `导出选中`：将选中设备传给 `export.start(payload)`，按有效配置执行导出。
- 辅助：过滤与排序（容量/卷标/最近见到），空态与错误提示统一处理；加载状态与禁用按钮联动。
- 验收：插入后自动识别并展示；操作交互稳定无异常；容量与状态准确。

## 设备级设置（新增）

- 目标：按设备覆盖全局 `AppSettings`，实现设备定制化导出策略。
- 数据模型：`DeviceSettings`（唯一键 `deviceId`），包含可选覆盖字段：
  - `exportTargetPathOverride`、`renameTemplateOverride`、`extensionsOverride(JSON)`
  - `concurrencyOverride`、`retryCountOverride`、`clearAfterExportOverride`
  - `enabled`、`lastAppliedAt`
- 合并策略：`EffectiveSettings = { ...AppSettings, ...DeviceSettingsOverrides }`（仅覆盖已赋值字段）。
- IPC：
  - `device.settings.get(deviceId)` 读取设备级设置（若不存在返回空与全局）。
  - `device.settings.update(deviceId, partial)` 更新并校验（`zod`）。
  - `device.settings.reset(deviceId)` 清除覆盖，回退全局。
- UI：在设备识别页面以侧栏/对话框形式编辑；校验路径白名单、模板合法性、扩展名数组、并发/重试范围等。
- 验收：设置保存后导出行为按预期变化；重置后回退全局；输入非法被拦截。

## 事件驱动刷新（新增）

- 主进程集成 `usb-detection`，设备插拔事件通过频道 `device:changed` 推送 `{ action: 'added'|'removed', ts }`。
- 渲染端在设备页订阅 `window.api.onDeviceChanged(handler)`，收到事件后自动触发 `device.list` 刷新设备列表。
- 保留手动“刷新”按钮作为兜底；如事件或权限异常，仍可手动刷新。
- 验收：插拔后设备列表自动更新且容量显示准确，无未捕获异常。

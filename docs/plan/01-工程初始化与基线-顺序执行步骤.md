# M0 顺序执行步骤

本文件将《01-工程初始化与基线（M0）》的“执行步骤”拆分为可直接按序完成的操作清单，适配 Windows 11 与 Electron 39 + electron-vite 4 项目结构。

## 步骤 1：依赖与脚本校验

- 检查 `package.json` 是否包含脚本：`format`、`lint`、`typecheck`、`build`、`start`、`qa`
- 执行 `pnpm install`，确保 `pnpm-lock.yaml` 与依赖一致

## 步骤 2：Electron 安全基线

- 主/渲染分离并启用 `contextIsolation: true`、`sandbox: true`
- 禁用 `remote` 模块，仅通过 `preload`/`contextBridge` 暴露白名单 API
- 为 IPC 调用增加输入/输出最小化与轻量校验（Schema 校验）

## 步骤 3：接入 electron-log

- 默认日志级别 `info`，主/渲染均启用
- 输出到文件并同步打印到控制台；Windows 日志目录：`%APPDATA%/InsightRecorder/logs`
- 主进程捕获 `uncaughtException` 与 `unhandledRejection`，写入日志并提示用户收集日志

## 步骤 4：测试配置（Vitest）

- 新增脚本：
  - `pnpm run test`: `vitest --run --config tests/vitest.config.ts`
  - `pnpm run test:watch`: `vitest --config tests/vitest.config.ts`
- 在 `tests/` 目录新增：
  - `vitest.config.ts`（`environment: 'node'`，渲染端可选 `jsdom` 子配置）
  - `setup.ts`（全局初始化/模拟、环境变量与 polyfill）
  - `globals.d.ts`（全局测试类型与扩展）
  - `tsconfig.test.json`（继承主配置，排除打包产物，包含 `tests/**/*`）
- 测试用例目录：`tests/unit/**`、`tests/e2e/**`

## 步骤 5：前端路由初始化（tanstack router）

- 在 `src/renderer/src/router.tsx` 使用 `createRouter` 与 `createHashHistory`（Electron 环境使用 Hash）
- 在 `src/renderer/src/main.tsx` 集成 `<RouterProvider router={router} />`
- 基础路由：`/`（首页/设备）、`/library`（文件库）、`/settings`（设置）
- 路由文件约定：`src/renderer/src/routes/**`

## 步骤 6：Ant Design 5 集成

- 在入口引入样式重置：`antd/dist/reset.css`
- 在 `src/renderer/src/App.tsx` 外层包裹 `ConfigProvider`
- 主题算法：默认 `defaultAlgorithm`，支持 `darkAlgorithm`；自定义 `token`（如 `colorPrimary`、`borderRadius`）
- 设置：`locale: zh_CN`，`prefixCls: 'ir'`

## 步骤 7：Tailwind 集成（渲染端）

- 安装依赖：`pnpm add -D tailwindcss @tailwindcss/vite`
- 在 `electron.vite.config.ts` 的 `renderer.plugins` 追加 `tailwindcss()`（`import tailwindcss from '@tailwindcss/vite'`）
- 新增入口样式 `src/renderer/src/styles/tailwind.css`，包含：
  - `@tailwind base;`
  - `@tailwind components;`
  - `@tailwind utilities;`
- 在 `src/renderer/src/main.tsx` 引入上述样式文件
- 在仓库根新增 `tailwind.config.ts`：
  - `content: ['src/renderer/index.html', 'src/renderer/src/**/*.{ts,tsx}']`
  - 不设置 `prefix`
  - `corePlugins: { preflight: false }`（关闭基础重置，减少与 AntD 冲突）

## 步骤 8：目录与别名约定

- 现有别名：`@renderer` → `src/renderer/src`
- 建议新增：`@main` → `src/main`，`@preload` → `src/preload`
- 保证 TS 路径与 Vite 别名一致；全局 `window` 注入类型来源：`src/preload/index.d.ts`

## 步骤 9：环境变量策略

- 渲染端：`import.meta.env`，仅访问 `VITE_` 前缀变量
- 主/预加载：`process.env`，开发模式可通过 `dotenv` 加载
- 文件：`.env.development`、`.env.production`

## 步骤 10：CSP 配置

- 在 `src/renderer/index.html` 添加 `Content-Security-Policy`：
  - `default-src 'self';`
  - `script-src 'self';`
  - `style-src 'self' 'unsafe-inline';`
  - `img-src 'self' data:`
- 开发模式追加：`connect-src 'self' ws:`；如使用 Worker：`worker-src 'self' blob:`

## 步骤 11：验证与冒烟

- 运行：`pnpm qa` → 期望 0 error
- 构建：`pnpm run build` → 成功
- 预览：`pnpm run start` → 应用可启动；验证：
  - 路由在 `/#/` 正常切换首页/文件库/设置
  - AntD 主题与语言生效、无样式冲突
  - Tailwind 工具类（如 `flex items-center gap-2`）生效
  - 渲染端无法直接访问 Node API（安全基线）
  - `electron-log` 写入文件与控制台；主/渲染异常可捕获并落盘

## 步骤 12：结果维护

- 如新增脚本或规则：更新 `README.md` 与项目规则文件
- 如影响产品功能：在 `docs/初始需求文档.md` 添加“实现进展/注意事项”小节

# 工程初始化与基线（M0）

## 范围

- Electron 39 + electron-vite 4 工程可运行；启用 `contextIsolation`、`sandbox`。
- 统一脚本：`pnpm qa`、`build`、`start` 可用；ESLint/Prettier 规则生效。

## 执行步骤

- 校验并完善 `package.json` 脚本与依赖；确保 pnpm 锁文件一致。
- 主/渲染分离与 `preload` 仅白名单暴露；禁用 `remote`；IPC Schema 校验。
- 接入 `electron-log` 日志记录。
  - 日志级别与输出：默认 `info`，主/渲染均启用；输出到文件并同步打印到控制台
  - 日志文件：位于应用数据目录（Windows：`%APPDATA%/InsightRecorder/logs`），建议启用按日期切分与最大保留天数
  - 异常捕获：主进程 `uncaughtException` 与 `unhandledRejection` 写入日志并提示用户收集日志
- 测试配置（Vitest）：配置文件集中到 `tests/` 目录
  - 新增脚本：`pnpm run test`（`vitest --run --config tests/vitest.config.ts`）、`pnpm run test:watch`（`vitest --config tests/vitest.config.ts`）
  - 配置文件：`tests/vitest.config.ts`（`environment: 'node'`，为渲染端测试可选 `jsdom` 子配置；别名与 TS 路径对齐）
  - 启动文件：`tests/setup.ts`（全局初始化/模拟、环境变量与 polyfill）
  - 类型声明：`tests/globals.d.ts`（全局测试类型与扩展）
  - TS 配置：`tsconfig.test.json`（继承主配置，排除打包产物，包含 `tests/**/*`）
  - 目录约定：测试用例统一放置 `tests/unit/**`、`tests/e2e/**`，按模块分层
- 前端路由（tanstack router）配置：集中初始化与入口集成
  - 路由入口：`src/renderer/src/router.tsx` 使用 `createRouter` 与 `createHashHistory`（Electron 环境优先使用 Hash，避免深链问题）
  - 基础路由：`/`（首页/设备）、`/library`（文件库）、`/settings`（设置）；按模块拆分子路由
  - 入口集成：在 `src/renderer/src/main.tsx` 使用 `<RouterProvider router={router} />`
  - 路由文件约定：按功能分包 `src/renderer/src/routes/**`，避免与页面逻辑耦合
  - 导航策略：通过状态管理与路由联动，禁用直接访问主进程 API（仅经 `preload` 白名单）
- Ant Design 5 配置：全局主题与样式重置集中化
  - 样式重置：在入口引入 `antd/dist/reset.css`
  - 全局配置：`src/renderer/src/App.tsx` 外层包裹 `ConfigProvider`
  - 主题算法：默认 `defaultAlgorithm`，支持切换 `darkAlgorithm`；自定义 `token`（如 `colorPrimary`、`borderRadius`）
  - 语言与前缀：`locale: zh_CN`，`prefixCls: 'ir'` 保持样式隔离
  - 组件使用约定：图标从 `@ant-design/icons` 引入；表单/布局使用 v5 新 API；不引入废弃 API

- Tailwind 配置：在渲染端集成实用类样式（与 AntD 协同）
  - 安装依赖：`pnpm add -D tailwindcss @tailwindcss/vite`
  - Vite 集成：在 `electron.vite.config.ts` 的 `renderer.plugins` 追加 `tailwindcss()`（`import tailwindcss from '@tailwindcss/vite'`）
  - 基础样式：新增入口样式文件（如 `src/renderer/src/styles/tailwind.css`）并包含 `@tailwind base; @tailwind components; @tailwind utilities;`，在 `src/renderer/src/main.tsx` 入口引入
  - 配置文件：`tailwind.config.ts`（Electron-Vite 目录根）
    - `content`: `['src/renderer/index.html', 'src/renderer/src/**/*.{ts,tsx}']`
    - 不设置 `prefix`（使用默认类名即可）
    - `corePlugins`: `{ preflight: false }`（关闭基础重置，沿用 `antd/dist/reset.css`，减少样式冲突）
  - 约定：仅在渲染端使用 Tailwind；主进程与预加载无需集成；组件库样式覆盖统一通过 AntD 主题与少量 Tailwind 工具类配合

## 验收标准

- 运行 `pnpm qa` 0 error；`pnpm run build` 成功；`pnpm run start` 可启动。
- 安全配置生效，渲染端无法直接访问 Node API。
- 运行 `pnpm run test` 显示 0 failed；所有 Vitest 相关配置文件位于 `tests/`，脚本可正确识别与执行。
- 路由：应用启动后可在 `/#/` 路由切换首页/文件库/设置；刷新不丢失状态（基础场景）
- AntD：`ConfigProvider` 生效，主题与语言正确；样式重置应用且无组件样式冲突
- Tailwind：工具类可正常应用（示例：在任意页面添加 `flex items-center gap-2` 生效），与 AntD 样式无冲突；构建产物包含 Tailwind 生成的 CSS
- 别名与类型：`@renderer`/`@main`/`@preload` 引用正常；`tsc --noEmit` 0 error 且全局 `window` 注入类型可用
- 环境变量：开发/生产环境变量可识别；渲染端仅访问 `VITE_` 前缀变量，敏感项未泄露
- 日志与异常：`electron-log` 写入文件与控制台；主/渲染异常可捕获并落盘
- CSP：开发模式 HMR 正常（`ws` 连接可用），生产无外域脚本与样式加载

## 风险与缓解

- Windows 环境差异：全部脚本走 `pnpm` 与 cross-platform 配置；日志排查。
- Electron/渲染测试环境差异：默认使用 `environment: 'node'`；需要 DOM 的测试使用 `jsdom`；对 Electron API 采用 `preload` 层模拟与 IPC stub；避免直接访问主进程。
- 路由深链与资源路径：使用 Hash History；避免 `file://` 深路径导致 404；静态资源走相对路径
- AntD 主题与性能：CSS Reset 仅引入一次；主题切换通过状态驱动，避免频繁重新渲染
- Tailwind 与样式冲突：禁用 `preflight`，无需类名前缀；遵循“渲染端限定”策略；如需覆盖组件样式优先通过 AntD 主题 token 实现，Tailwind 仅用于布局与间距
- 环境变量与安全：渲染端仅读取 `VITE_` 变量；主进程敏感配置不经 `preload` 直传
- 别名错配：TS 路径与 Vite 别名必须一致；如编译/运行时报模块找不到，统一调整两端配置
- 日志膨胀：限制日志保留与大小；高频调试信息仅在开发环境输出
- 安全与 CSP 细则：统一约束渲染端资源访问
  - `index.html` 的 `Content-Security-Policy`：`default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:`
  - 开发模式需追加：`connect-src 'self' ws:` 以允许 HMR；如使用 Worker：`worker-src 'self' blob:`
  - 禁止远程脚本与不可信资源；所有资源走打包产物与本地文件

- 目录与别名约定：统一路径引用与类型解析
  - 现有别名：`@renderer` → `src/renderer/src`
  - 建议新增：`@main` → `src/main`，`@preload` → `src/preload`
  - TS 路径与 Vite 别名保持一致，避免导入混乱

- 环境变量策略：区分主/渲染加载方式
  - 渲染端：使用 `import.meta.env`，变量以 `VITE_` 前缀声明；文件：`.env.development`、`.env.production`
  - 主/预加载：使用 `process.env`，必要时通过 `dotenv` 在开发模式加载；严禁在渲染端暴露敏感变量
  - 配置项示例：日志级别、后端服务地址（如本地微服务）

- TypeScript 配置分层：严格类型与分端编译
  - `tsconfig.node.json`（主/预加载）：目标 `ES2022`，`module` 为 `CommonJS`/`NodeNext`，开启 `strict`
  - `tsconfig.web.json`（渲染）：目标 `ES2022`，`module` 为 `ESNext`，`jsx` 使用 `react-jsx`
  - 顶层 `tsconfig.json` 统一基础规则与路径映射，禁用 `any`，公共导出显式返回类型

- 预加载类型与白名单：对外暴露 API 的定义与校验
  - 类型文件：`src/preload/index.d.ts` 为 `window` 注入的接口定义来源
  - 白名单规则：仅暴露必要的只读/受控方法；输入输出参数做最小化与校验（可用轻量校验函数实现）

- 构建与调试：开发体验与产物质量
  - 开发模式开启 `sourcemap` 与 React DevTools；生产构建关闭 DevTools、保留 `source-map` 便于异常定位（可选）
  - 资源路径：使用相对路径与 Hash History，避免 `file://` 深链导致 404

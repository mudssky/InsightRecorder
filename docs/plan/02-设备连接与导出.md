# 设备连接与导出（M1）

## 目标

- 自动识别录音笔为可移动磁盘；一键批量导出新文件并支持重命名与目标路径配置。

## 范围

- 设备检测：`drivelist`；目录监听：`chokidar`；扫描：`fast-glob`。
- 导出后可选“清空录音笔”与容量显示。
- 手动连接兜底：支持选择设备根目录作为挂载点（当自动识别失败时）。
- 容量采集：推荐 `check-disk-space` 获取盘符容量；展示已用/剩余。

## 执行步骤

- 主进程集成设备枚举与插拔事件；渲染端展示设备与容量。
- 批量导出：支持过滤“新文件”；命名规则：日期/时间/主题模板。
- 导出设置持久化至 SQLite（Prisma）。
- 清空选项需二次确认与回收站策略配合。
- 设备识别页面与设备级设置：设备列表、设备卡片、独立配置覆盖全局设置。
- 导出进度与取消：IPC 推送任务进度，支持用户取消；失败重试与并发控制（建议 `p-queue`）。
- 预检与冲突策略：校验目标目录可用空间、目的地重名处理（唯一命名/覆盖策略）。
- 事件驱动刷新：使用 `usb-detection` 捕获插拔事件并通过 `device:changed` 频道通知渲染端，自动刷新设备列表。

## 配置存储（SQLite 数据表与持久化）

- 存储位置：数据库文件置于 `app.getPath('userData')/insight-recorder.db`，由主进程独占连接；渲染端仅通过 IPC 访问，不直接操作数据库。
- ORM 建议：优先使用 Prisma（后续引入 Migrations 管理架构演进）。
- 表设计：
  - `AppSettings`（全局导出配置）
    - `id` INTEGER PRIMARY KEY
    - `exportTargetPath` TEXT NOT NULL（导出目标目录）
    - `renameTemplate` TEXT NOT NULL（重命名模板，默认 `{date:YYYYMMDD}-{time:HHmmss}-{title}-{device}`）
    - `extensions` TEXT NOT NULL（JSON 字符串，音频扩展名列表，如 `[".wav",".mp3",".m4a"]`）
    - `concurrency` INTEGER NOT NULL DEFAULT 3（并发数）
    - `retryCount` INTEGER NOT NULL DEFAULT 2（失败重试次数）
    - `clearAfterExport` BOOLEAN NOT NULL DEFAULT 0（导出后是否清空设备）
    - `createdAt` DATETIME NOT NULL
    - `updatedAt` DATETIME NOT NULL
  - `Device`（设备索引与容量）
    - `id` INTEGER PRIMARY KEY
    - `vendorId` TEXT
    - `productId` TEXT
    - `serial` TEXT
    - `label` TEXT（设备显示名称/卷标）
    - `mountpoint` TEXT（盘符/挂载点）
    - `capacityTotal` INTEGER（总容量，字节）
    - `capacityFree` INTEGER（剩余容量，字节）
    - `lastSeenAt` DATETIME NOT NULL
    - 唯一约束：`serial` 或组合 `vendorId+productId+serial`
  - `DeviceSettings`（设备级配置覆盖，全局 `AppSettings` 的按设备重写）
    - `id` INTEGER PRIMARY KEY
    - `deviceId` INTEGER NOT NULL（外键 `Device.id`，唯一）
    - `exportTargetPathOverride` TEXT
    - `renameTemplateOverride` TEXT
    - `extensionsOverride` TEXT（JSON 字符串）
    - `concurrencyOverride` INTEGER
    - `retryCountOverride` INTEGER
    - `clearAfterExportOverride` BOOLEAN
    - `enabled` BOOLEAN NOT NULL DEFAULT 1
    - `lastAppliedAt` DATETIME
    - 唯一约束：`deviceId`
  - `ExportHistory`（导出任务记录）
    - `id` INTEGER PRIMARY KEY
    - `deviceId` INTEGER NOT NULL（外键 `Device.id`）
    - `srcPath` TEXT NOT NULL
    - `destPath` TEXT NOT NULL
    - `size` INTEGER NOT NULL
    - `mtimeMs` INTEGER NOT NULL
    - `status` TEXT NOT NULL（`SUCCESS|FAILED|SKIPPED|CANCELLED`）
    - `error` TEXT（失败原因）
    - `startedAt` DATETIME NOT NULL
    - `finishedAt` DATETIME
    - 索引：`deviceId`、`srcPath`、`mtimeMs`
  - `ExportIndex`（已导出指纹，用于“新文件”判定）
    - `id` INTEGER PRIMARY KEY
    - `deviceId` INTEGER NOT NULL
    - `srcPath` TEXT NOT NULL
    - `size` INTEGER NOT NULL
    - `mtimeMs` INTEGER NOT NULL
    - 可选 `fingerprint` TEXT（哈希或组合指纹）
    - 唯一约束：`deviceId+srcPath+size+mtimeMs`
- 事务与一致性：单次导出任务在 `ExportHistory` 记录开始与结束，成功后写入 `ExportIndex`；失败保留 `error` 并可重试。
- IPC 映射（经 `preload` 暴露并做 schema 校验）：
  - `settings.get`（读取最新一条 `AppSettings`，若空返回默认值）
  - `settings.update(partial)`（更新并写 `updatedAt`）
  - `device.list`（返回 `Device` 最近一次扫描结果；为空时触发扫描并写入）
  - `device.settings.get(deviceId)`（读取设备级设置，无则返回空与全局）
  - `device.settings.update(deviceId, partial)`（更新设备级设置并校验）
  - `device.settings.reset(deviceId)`（清除覆盖，回退全局）
  - `export.start(payload)`（基于配置与设备启动导出，期间写 `ExportHistory`/`ExportIndex`）
  - `export.cancel(taskId)`（取消进行中的导出任务，写 `status: CANCELLED`）
  - `export.progress`（事件流/频道，推送进度与当前文件信息）
  - `device.changed`（事件流/频道，推送设备插拔变更，用于 UI 自动刷新）
  - `export.summary(limit)`（返回最近 N 次导出摘要）
- 安全与路径约束：导出目标需在受信目录白名单内，所有 IPC 参数与返回做 `zod` 校验；渲染端不可直接持有数据库句柄。
- 备份与迁移：提供数据库备份导出到用户指定目录；后续用 Prisma Migrations 管理结构升级与数据迁移。

## 验收标准

- 插入设备后自动识别并展示；手动选择目录可兜底连接。
- 设备识别页面与设备级设置可用；覆盖生效且可重置回全局。
- 一键导出成功；重命名符合规则；容量准确显示；导出进度可视并可取消。
- 目的地空间不足与重名文件能被正确处理（预检与策略）。

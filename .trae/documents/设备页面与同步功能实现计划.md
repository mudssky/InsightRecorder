## 目标概述

- 完善设备列表与详情、按设备可配置的同步策略、插入设备的交互与自动同步

- 引入持久层存储设备与文件元数据，支撑统计、去重与历史查询

## 存储方案选择

- 建议：采用 SQLite 作为本地持久层（便于查询与复杂统计）

- ORM 选型：
  - 首选 `drizzle-orm` + `better-sqlite3`（打包轻、原生依赖少、Electron 适配好）

- 结论：如无强诉求用 drizzle-orm，优先 `drizzle + better-sqlite3`；若团队已有 drizzle-orm 经验，也可选 drizzle-orm，但需额外打包与生成配置

## 数据库表设计

- `devices`
  - `id`（主键，设备稳定 UID；盘符为回退）、`label`、`mountpoint`

  - `type`（`recorder/generic/ignored`）、`autoSync`、`deleteSourceAfterSync`

  - `syncRootDir`、`folderNameRule`、`folderTemplate`

  - `extensions`（JSON 数组）、`minSize`、`maxSize`

  - `createdAt`、`updatedAt`、`lastSeenAt`、`lastSyncAt`

- `files`
  - `id`（主键）、`deviceId`（外键）、`relativePath`、`size`、`mtimeMs`

  - `fingerprint`（`deviceId|path|size|mtimeMs`）、`contentHash`（可选）

  - `title`/`duration`（可选元数据）

  - 索引：`fingerprint` 唯一、`deviceId+relativePath`

- `sync_jobs`
  - `id`（任务 ID）、`status`（`RUNNING/SUCCEEDED/FAILED/CANCELLED`）

  - `deviceId`、`startedAt`、`endedAt`

  - `copiedCount`、`skippedCount`、`failedCount`

- `sync_events`
  - `id`、`jobId`、`stage`（`copied/skip/failed`）、`fileId`、`ts`、`error`（可空）

## 主进程集成

- 初始化 SQLite 连接于主进程；暴露 IPC：
  - `db:devices:get(id)`、`db:devices:upsert(payload)`、`db:devices:list()`

  - `db:files:listByDevice(id)`、`db:files:upsertMany(deviceId, files)`

  - `db:jobs:create(deviceId)`、`db:jobs:update(id, partial)`、`db:events:append(batch)`

- 同步流程更新：
  - 枚举设备 → 依据设备配置（扩展名/大小）扫描 → 写入/更新 `files`

  - 去重先查 `files.fingerprint`，必要时比对 `contentHash`

  - 复制成功即记录 `sync_events` 与累加计数；任务结束汇总进 `sync_jobs`

  - 若开启“同步后删除源文件”，在复制成功后删除，失败写事件并不中断总体任务

## 预加载与类型

- 对应新增 IPC 封成 API，并在 `preload/index.d.ts` 定义类型：
  - `getDeviceSettings(id)` / `updateDeviceSettings(id, partial)` → 映射 `db:devices:*`

  - `getDeviceStats(id)`：基于 DB 返回 `fileCount/syncedCount/lastSyncAt`

  - `listDeviceFiles(id)`：用于详情页展示与排查

- 保持 `contextIsolation` 与参数校验（白名单与 schema 约束）

## 渲染层改造

- `Devices.tsx`：展示容量/已用、`fileCount`、`syncedCount`、`lastSyncAt`；点击进入详情

- `DeviceDetail.tsx`：表单编辑设备配置（类型、自动同步、删除源文件、根目录、模板、扩展名、大小区间）；显示文件列表与统计；“保存设置/立即同步”

- 插入设备交互：
  - `device:changed added` → 若未配置或未启用自动同步，则弹窗收集配置；否则直接同步

  - 提供“以后自动同步不再提示”全局项

## 模板与路径

- 预设命名方式：`{label}-{id}`、`{id}/{date}`、`{label}/{date}`

- 模板占位：`{deviceLabel}`、`{deviceId}`、`{date:YYYYMMDD}`、`{time:HHmmss}`、`{counter}`、`{title}`

- 路径安全：清理非法字符、限制深度与长度；Windows 特殊名与长路径处理

## UID 稳定性

- 优先使用 `drivelist` 的 `serialNumber/devicePath/description` 组合生成稳定 `uid`；盘符作为回退

- 当 `uid` 变化时，提供合并与迁移策略（用户可选择）

## 验证与交付

- `pnpm qa`（类型检查、Lint、格式化）

- `pnpm build` → `pnpm start` 冒烟验证：列表/详情/插入弹窗/同步流程

- 记录 TODO：补充 Vitest 最小用例（模板生成/文件过滤/DB 读写）

## 迭代增强

- 内容哈希去重（可开关），跨设备合并

- 历史视图与失败重试、并发与速率限制、冲突重命名策略

- 模板占位扩展（日期细粒度、元数据）
